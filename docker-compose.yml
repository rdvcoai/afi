services:
  # 1. VISUALIZACIÓN (Streamlit)
  afi-dashboard:
    build: ./afi-dashboard
    container_name: afi_dashboard
    restart: always
    volumes:
      - ./afi-dashboard:/app
    environment:
      - CORE_URL=http://afi-core:8080
      - DB_HOST=afi_db
      - DB_USER=afi_user
      - DB_PASS=${DB_PASSWORD}
      - DB_NAME=afi_brain
    networks:
      - afi_network

  # 2. ADMINISTRACIÓN (NocoDB)
  afi-nocodb:
    image: nocodb/nocodb:latest
    container_name: afi_nocodb
    restart: always
    environment:
      - NC_DB=pg://afi_db:5432?u=afi_user&p=${DB_PASSWORD}&d=afi_brain
    networks:
      - afi_network

  # 3. EL CEREBRO (Python)
  afi-core:
    build: ./afi-core
    container_name: afi_core
    depends_on:
      - afi_db
    volumes:
      - ./afi-core:/app
      - ./afi-dashboard:/app/dashboard_code
      - ./data/books:/app/data/books
      - ./data/csv:/app/data/csv
      - ./data/onedrive_import:/app/data/onedrive_import
      - ./backups:/app/backups
      - ./data/media:/app/data/media
      - ./data/media:/app/media
      - ${HOME}/.config/rclone/rclone.conf:/root/.config/rclone/rclone.conf:rw
    env_file: .env
    environment:
      - DB_HOST=afi_db
      - DB_USER=afi_user
      - DB_PASS=${DB_PASSWORD}
      - DB_NAME=afi_brain
      - BRIDGE_URL=http://afi-whatsapp:3000
      - WHATSAPP_PUSH_URL=http://afi-whatsapp:3000/send
      - DASHBOARD_URL=https://afi.rdv.net.co
      - PYTHONDONTWRITEBYTECODE=1
    ports:
      - "8080:8080"
    networks:
      - afi_network
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]

  # 4. LA INTERFAZ BLINDADA (Node.js)
  afi-whatsapp:
    build: ./afi-whatsapp
    container_name: afi_whatsapp
    depends_on:
      - afi-core
    restart: always
    env_file: .env
    environment:
      - CORE_URL=http://afi-core:8080
      - PORT=3000
      - MEDIA_DIR=/app/data/media
    volumes:
      - ./afi-whatsapp/session:/app/data/session
      - ./data/media:/app/data/media
    ports:
      - "3000:3000"
    networks:
      - afi_network

  # BASE DE DATOS UNIFICADA
  afi_db:
    image: ankane/pgvector:latest
    container_name: afi_db
    restart: always
    environment:
      POSTGRES_USER: afi_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: afi_brain
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - afi_network

  # 6. PROXY REVERSO (NGINX)
  nginx:
    image: nginx:latest
    container_name: afi_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - afi-core
      - afi-dashboard
      - afi-nocodb
    networks:
      - afi_network

  # 7. GESTOR SSL (CERTBOT)
  certbot:
    image: certbot/certbot
    container_name: afi_certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

networks:
  afi_network:
    driver: bridge
